@page "/posts/{id:int}/edit"

@attribute [Authorize]

@using ApiContracts.Posts;
@using ApiContracts.Comments;
@inject BlazorApp.Services.IPostService Posts
@inject NavigationManager Nav

<h3>Edit Post</h3>

@if (!string.IsNullOrWhiteSpace(error))
{
    <p style="color:red">@error</p>
}

@if (isLoading)
{
    <p>Loading...</p>
}
else if (model is null)
{
    <p>Post not found.</p>
}
else
{
    <!-- Prefill form -->
    <div style="max-width:600px">
        <div class="mb-2">
            <label>Title</label><br />
            <input @bind="model.Title" />
        </div>

        <div class="mb-2">
            <label>Body</label><br />
            <textarea @bind="model.Body" rows="6" cols="60"></textarea>
        </div>

        <div class="mb-2">
            <button @onclick="Save">Save</button>
            <a href="@($"/posts/{id}")" style="margin-left:10px">Cancel</a>
        </div>

        @if (!string.IsNullOrWhiteSpace(ok))
        {
            <p style="color:green">@ok</p>
        }
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    // „view model” for edit: only what we update
    private UpdatePostDto? model;
    private bool isLoading = true;
    private string? error;
    private string? ok;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        error = ok = null;

        try
        {
            // Fetch existing post, to fill form
            var existing = await Posts.GetByIdAsync(id);

            // Prefill – only fields that backend accepts in UpdatePostDto
            model = new UpdatePostDto
            {
                Title = existing.Title,
                Body  = existing.Body
            };
        }
        catch (Exception ex)
        {
            error = $"Cannot load post: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Save()
    {
        error = ok = null;

        if (model is null)
        {
            error = "Nothing to save.";
            return;
        }
        if (string.IsNullOrWhiteSpace(model.Title))
        {
            error = "Title is required.";
            return;
        }
        if (string.IsNullOrWhiteSpace(model.Body))
        {
            error = "Body is required.";
            return;
        }

        try
        {
            await Posts.UpdateAsync(id, model);
            // Short feedback and redirect to post details
            ok = "Saved.";
            Nav.NavigateTo($"/posts/{id}");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

}
